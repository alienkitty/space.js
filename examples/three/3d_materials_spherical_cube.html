<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <title>Materials Spherical Cube â€” Space.js</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="../assets/css/style.css">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three/build/three.module.js",
                "three/addons/": "https://unpkg.com/three/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import { BoxGeometry, Color, HemisphereLight, Mesh, MeshNormalMaterial, MeshPhongMaterial, PerspectiveCamera, SRGBColorSpace, Scene, TextureLoader, Vector2, WebGLRenderer } from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { getSphericalCube } from '../../src/three.js';

        // init

        const renderer = new WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const scene = new Scene();
        scene.background = new Color(0x060606);

        const camera = new PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = 10;

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // lights

        scene.add(new HemisphereLight(0xffffff, 0x888888, 3));

        // loaders

        const textureLoader = new TextureLoader();
        textureLoader.setPath('/examples/assets/textures/');

        // mesh

        const geometry = getSphericalCube(0.65);
        geometry.computeTangents();

        const material = createCubeFaceMaterial({
            nameFaces: [
                'px',
                'nx',
                'py',
                'ny',
                'pz',
                'nz'
            ],
            mapFaces: await Promise.all([
                textureLoader.loadAsync('cube/mars/mars_basecolor_px.jpg'),
                textureLoader.loadAsync('cube/mars/mars_basecolor_nx.jpg'),
                textureLoader.loadAsync('cube/mars/mars_basecolor_py.jpg'),
                textureLoader.loadAsync('cube/mars/mars_basecolor_ny.jpg'),
                textureLoader.loadAsync('cube/mars/mars_basecolor_pz.jpg'),
                textureLoader.loadAsync('cube/mars/mars_basecolor_nz.jpg')
            ]),
            normalFaces: await Promise.all([
                textureLoader.loadAsync('cube/mars/mars_normal_px.jpg'),
                textureLoader.loadAsync('cube/mars/mars_normal_nx.jpg'),
                textureLoader.loadAsync('cube/mars/mars_normal_py.jpg'),
                textureLoader.loadAsync('cube/mars/mars_normal_ny.jpg'),
                textureLoader.loadAsync('cube/mars/mars_normal_pz.jpg'),
                textureLoader.loadAsync('cube/mars/mars_normal_nz.jpg')
            ])
        });

        const mesh = new Mesh(geometry, material);
        scene.add(mesh);

        // panel

        import { MaterialPanelController, Point3D, UI } from '../../src/three.js';

        const ui = new UI({ fps: true });
        ui.animateIn();
        document.body.appendChild(ui.element);

        Point3D.init(renderer, scene, camera);

        const point = new Point3D(mesh);
        scene.add(point);

        MaterialPanelController.init(mesh, point);

        // animation

        function animate(time) {
            requestAnimationFrame(animate);

            time = time * 0.001; // seconds

            controls.update();

            renderer.render(scene, camera);

            Point3D.update(time);
            ui.update();
        }

        requestAnimationFrame(animate);

        // resize

        window.addEventListener('resize', onWindowResize);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // helpers

        function createCubeFaceMaterial({ nameFaces, mapFaces, normalFaces }) {
            return nameFaces.map((texture, index) => {
                const name = nameFaces[index];
                const map = mapFaces[index];
                const normalMap = normalFaces[index];

                map.colorSpace = SRGBColorSpace;

                const material = new MeshPhongMaterial({
                    name,
                    map,
                    normalMap,
                    normalScale: new Vector2(2, -2),
                    shininess: 0,
                    reflectivity: 0.1,
                    fog: false
                });

                return material;
            });
        }
    </script>
</head>
<body>
</body>
</html>
